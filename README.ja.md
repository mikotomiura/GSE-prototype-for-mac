# GSE (Generative Struggle Engine) Prototype v2

GSE (Generative Struggle Engine) は、コーディングや執筆などの創造的作業におけるユーザーの**内面的認知状態 (Cognitive State)** をリアルタイムに推定・可視化し、最適な状態へ誘導するための実験的システムです。
キーストロークの動的特徴（入力リズムや修正パターン）を分析し、ユーザーが「集中（Flow）」「思考（Incubation）」「停滞（Stuck）」のどの状態にあるかを判定します。

## 🌟 主な機能

### 1. リアルタイム認知状態推論
- **隠れマルコフモデル (HMM)**: 観測可能なキーストローク情報（Flight Time）から、不可視の認知状態を確率的に推定します。
- **マイクロ行動分析**:
  - **入力リズム**: 高速かつ一定のリズムは **Flow (集中)** と判定。
  - **停止（Pause）**:
    - 短い停止（1.5秒 〜 5.0秒）は **Stuck (迷い/停滞)** の兆候。
    - 長い停止（5.0秒以上）は **Incubation (休憩/思考放置)** として区別。
  - **修正パターン**:
    - **バックスペース連打**（特に3回以上連続）は **Stuck**（手戻り・思考の修正）として強く判定。
    - 日本語入力（IME）中の**スペースキー（変換）**や文字入力は **Flow**（生成的行為）として扱います。

### 2. アンビエント・フィードバック
- **Dashboard Widget**: 常に最前面に表示される小型ウィジェットで、現在の3状態（Flow / Incubation / Stuck）の確率をゲージで可視化します。
- **Mist (霧) エフェクト**: Stuck状態が長時間（約30秒以上）続くと、画面全体にうっすらと「霧」がかかるような視覚効果が発生し、ユーザーに気分転換やアプローチの変更を促します。

### 3. システム互換性
- **グローバル・フック**: Windows API (`WH_KEYBOARD_LL`) を使用し、どのアプリケーションを使用中であっても入力を検知します。
- **IME 対応**: 日本語入力の「変換候補ウィンドウ」が開いている間は推論を一時停止または保護し、変換中の思考停止を誤ってStuck判定しないように制御しています。
- **軽量動作**: Rust言語による最適化されたバックエンドにより、PCへの負荷を最小限に抑えています。

---

## 🛠️ 技術スタック

- **Frontend**: React, TypeScript, Vite
  - UI描画、アニメーション、状態の可視化を担当。
  - TauriのIPCコマンドを通じてバックエンドと通信。
- **Backend**: Rust, Tauri v2
  - **推論エンジン**: `CognitiveStateEngine` (HMM実装)。
  - **システム連携**: `windows-rs` (Win32 API) を用いたキーボードフックおよびIME状態監視。
- **OS**: Windows 10/11

---

## 📂 ファイル構成

```
GSE-Next/
├── src/
│   ├── components/
│   │   └── Dashboard.tsx       # メインUI、Mistエフェクトのロジック
│   ├── App.tsx                 # ルートコンポーネント
│   ├── App.css                 # デザインスタイル、アニメーション定義
│   └── main.tsx                # エントリーポイント
├── src-tauri/
│   ├── src/
│   │   ├── analysis/
│   │   │   ├── engine.rs       # HMM推論エンジン & 状態遷移ロジック
│   │   │   └── features.rs     # 特徴量抽出 (Flight Time, 指数平滑移動平均)
│   │   ├── input/
│   │   │   ├── hook.rs         # 低レイヤーキーボードフック (WH_KEYBOARD_LL)
│   │   │   └── ime.rs          # IME候補ウィンドウ監視
│   │   └── lib.rs              # ライブラリエントリー & コマンド登録
│   ├── tauri.conf.json         # Tauri設定 (権限、ウィンドウ設定)
│   └── Cargo.toml              # Rust依存関係
└── index.html                  # HTML エントリーポイント
```

---

## 🧠 技術詳細: 推論エンジンのロジック

GSEの中核は `engine.rs` に実装された **Cognitive State Engine** です。

### 定義された状態 (States)
1.  **Flow (集中)**: スムーズでリズミカルな入力。
2.  **Incubation (思考)**: 戦略的な長い停止、または待機。
3.  **Stuck (停滞)**: 不規則なリズム、頻繁な修正、短い躊躇。

### 処理フロー
1.  **入力検知**: `hook.rs` がシステム全体のキー押下・解放イベントをフック。
2.  **特徴量抽出**: `features.rs` が **Flight Time** (キーを離してから次のキーを押すまでの時間) を計算。
3.  **HMM 更新**: `engine.rs` が以下の要素に基づいて確率を更新:
    - **離散化 (Discretization)**: Flight Time をカテゴリ分け (例: <120ms=高速, 1.5s~5s=Stuckリスク)。
    - **遷移確率 (Transition)**: 状態間の移行しやすさを定義 (Stuckは一度陥ると抜け出しにくい "Sticky" な設定)。
    - **出力確率 (Emission)**: 各状態でどのような入力間隔が発生しやすいかの確率分布。
4.  **ヒューリスティクス (補正ロジック)**:
    - **バックスペース連打**: 3回以上の連続削除で、強制的にStuck確率を引き上げ。
    - **アイドル検知**: 5秒以上の無操作は、StuckではなくIncubation (Idle) へ誘導。
    - **IMEガード**: 変換候補ウィンドウ表示中は推論へのノイズとして扱わない。

---

## 🚀 ビルドと実行

### 前提条件
- Node.js (v18以上)
- Rust (Stable)
- Windows SDK (ネイティブAPI利用のため)

### コマンド
```bash
# 依存関係のインストール
npm install

# 開発モードで実行
npm run tauri dev

# 本番ビルド
npm run tauri build
```

---

## ⚠️ 注意事項
- 本アプリはキーボード入力を広範囲にフックするため、セキュリティソフトによって警告が出る場合があります。
- ダッシュボードの「システム終了 (System Exit)」ボタンは、プロセスを強制終了させるための緊急停止用です。
